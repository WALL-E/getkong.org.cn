<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/Article">
  
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <title>Plugin Development - Accessing the datastore - v0.9.x | Kong - Open-Source API Management and Microservice Management</title><!-- use share link for facebook -->
  <meta name="description" content="Secure, Manage &amp; Extend your APIs or Microservices with plugins for authentication, logging, rate-limiting, transformations and more.">
  <meta name="author" content="Mashape"/>
  <meta property="og:title" content="开源 API 管理平台和微服务管理平台"/>
  <meta property="og:site_name" content="Kong"/>
  
  <meta property="og:url" content="http://getkong.org"/>
  <meta property="og:description" content="Secure, Manage &amp; Extend your APIs or Microservices with plugins for authentication, logging, rate-limiting, transformations and more."/>
  <meta property="og:type" content="website"/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:image" content="https://getkong.org/assets/images/share.png"/>
  <meta name="twitter:card" content="summary_large_image"/>
  <meta name="twitter:site" content="@mashape"/>
  <meta name="twitter:creator" content="@mashape"/>
  <meta name="twitter:url" content="https://getkong.org"/>
  <meta name="twitter:description" content="Secure, Manage &amp; Extend your APIs or Microservices with plugins for authentication, logging, rate-limiting, transformations and more.">
  <meta name="twitter:image" content="https://getkong.org/assets/images/share.png">
  <meta property="fb:admins" content="227304446"/>
  <meta property="fb:admins" content="576641408"/>
  <meta name="google-site-verification" content="CrU3zp02dNKTe8NSAipL4NCPkrIjDXG8fViTZ-MIzP4"/>
  <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "Organization",
      "name": "Mashape",
      "url": "https://getkong.org",
      "logo": "https://getkong.org/assets/images/logo.png",
      "sameAs": [
        "https://www.facebook.com/Mashape",
        "https://twitter.com/mashape",
        "https://plus.google.com/+mashape"
      ]
    }
  </script>
  <link rel="icon" type="image/x-icon" href="/assets/images/favicon.ico"/>
  <link rel="stylesheet" href="//cloud.typography.com/7506032/804186/css/fonts.css"/>
  <link rel="stylesheet" href="/assets/styles.css?v=1474440736"/>
</head>


  <body id="documentation" >
    <header class="site-header">
  <div class="enterprise">
    <div class="container">
      <nav class="enterprise-sites one-half column">
        <ul>
          <li class="active"><a href="http://getkong.org">Kong</a></li>
          <li><a href="http://gelato.io">Gelato</a></li>
          <li><a href="http://getgalileo.io">Galileo</a></li>
          <li><a href="http://www.mashape.com/enterprise/">企业版</a></li>
        </ul>
      </nav>
      <nav class="enterprise-contact one-half column">
        <ul>
          <li><a href="https://www.mashape.com/enterprise/#demo-form">Request Demo</a></li>
          <li><a href="tel:+18664021473">Sales: +1 (866) 402-1473</a></li>
        </ul>
      </nav>
    </div>
  </div><!-- .enterprise -->
  <div class="navbar">
    <div class="container">
      <a href="/" class="navbar-brand"><img src="/assets/images/branding.svg" alt="Kong" width="99" height="32"></a>
      <iframe class="header-star" src="https://ghbtns.com/github-btn.html?user=Mashape&amp;repo=kong&amp;type=star"frameborder="0" scrolling="0" width="55" height="20"></iframe>
      <button data-toggle="collapse" data-target="#navbar" aria-expanded="true" aria-controls="navbar" class="navbar-toggle">
        <span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span>
      </button>
      <nav id="navbar" class="navbar-nav">
        <ul>
          <li><a href="/about/" >关于</a></li>
          <li><a href="/docs/"  class="active">文档</a></li>
          <li><a href="/plugins/" >插件</a></li>
          <li><a href="/community/" >社区版</a></li>
          <li><a href="https://www.mashape.com/enterprise/">企业版</a></li>
          <li><a href="https://github.com/Mashape/kong" target="_blank">GitHub</a></li>
          <li>
            <a href="/install/" class="button button-dark" data-analytics='{"event": "Clicked download", "type": "button", "location": "header"}'>安装</a>
          </li>
        </ul>
      </nav>
    </div>
  </div><!-- .navbar -->
</header>


    <header class="page-header">
  <div class="container">
    <div class="page-header-icon">
      <img src="/assets/images/icons/icn-documentation.svg" alt="Documentation" />
    </div>
    <div class="page-header-title">
      <h1>Documentation (0.9.x)</h1>
      <p>Learn how Kong empowers your APIs</p>
    </div>

    
      <div class="dropdown page-header-right">
        <button class="page-header-btn" id="version-dropdown" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          
          
          
          
          
          
          
          Version 0.9.x
          <em>(latest)</em>
          <span class="caret"></span>
        </button>

        <ul class="dropdown-menu dropdown-menu-right" role="menu" aria-labelledby="version-dropdown">
          
            
              <li>
                <a href="/docs/0.2.0-2">
                  
                  
                  
                  
                  
                  
                  
                  0.2.0-2
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                </a>
              </li>
            
          
            
              <li>
                <a href="/docs/0.2.x">
                  
                  
                  
                  
                  
                  
                  
                  0.2.x
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                </a>
              </li>
            
          
            
              <li>
                <a href="/docs/0.3.x">
                  
                  
                  
                  
                  
                  
                  
                  0.3.x
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                </a>
              </li>
            
          
            
              <li>
                <a href="/docs/0.4.x">
                  
                  
                  
                  
                  
                  
                  
                  0.4.x
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                </a>
              </li>
            
          
            
              <li>
                <a href="/docs/0.5.x">
                  
                  
                  
                  
                  
                  
                  
                  0.5.x
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                </a>
              </li>
            
          
            
              <li>
                <a href="/docs/0.6.x">
                  
                  
                  
                  
                  
                  
                  
                  0.6.x
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                </a>
              </li>
            
          
            
              <li>
                <a href="/docs/0.7.x">
                  
                  
                  
                  
                  
                  
                  
                  0.7.x
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                </a>
              </li>
            
          
            
              <li>
                <a href="/docs/0.8.x">
                  
                  
                  
                  
                  
                  
                  
                  0.8.x
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                </a>
              </li>
            
          
            
          
        </ul>
      </div>
    
  </div>
</header>

<div class="container">
  <aside class="page-navigation">
    

    
    <nav>
      
      <h5>Getting Started</h5>
      
      <ul>
        
        
        <li>
          <a href="/docs/0.9.x/getting-started/introduction" >简介</a>
          
        </li>
        
        
        <li>
          <a href="/docs/0.9.x/getting-started/quickstart" >Five-minute quickstart</a>
          
        </li>
        
        
        <li>
          <a href="/docs/0.9.x/getting-started/adding-your-api" >Adding your API</a>
          
        </li>
        
        
        <li>
          <a href="/docs/0.9.x/getting-started/enabling-plugins" >Enabling Plugins</a>
          
        </li>
        
        
        <li>
          <a href="/docs/0.9.x/getting-started/adding-consumers" >Adding Consumers</a>
          
        </li>
        
      </ul>
    </nav>
    
    <nav>
      
      <h5>Guides &amp; References</h5>
      
      <ul>
        
        
        <li>
          <a href="/docs/0.9.x/configuration" >Configuration reference</a>
          
        </li>
        
        
        <li>
          <a href="/docs/0.9.x/cli" >CLI reference</a>
          
        </li>
        
        
        <li>
          <a href="/docs/0.9.x/clustering" >Clustering reference</a>
          
        </li>
        
        
        <li>
          <a href="/docs/0.9.x/proxy" >Proxy reference</a>
          
        </li>
        
        
        <li>
          <a href="/docs/0.9.x/network" >Network &amp; Firewall</a>
          
        </li>
        
        
        <li>
          <a href="/docs/0.9.x/lua-reference/" >Public Lua API reference</a>
          
        </li>
        
        
        <li>
          <a href="/docs/0.9.x/plugin-development" >Plugin Development Guide</a>
          
          <ul>
            
            
            <li>
              <a href="/docs/0.9.x/plugin-development" >简介</a>
            </li>
            
            
            <li>
              <a href="/docs/0.9.x/plugin-development/file-structure" >File structure</a>
            </li>
            
            
            <li>
              <a href="/docs/0.9.x/plugin-development/custom-logic" >Implement custom logic</a>
            </li>
            
            
            <li>
              <a href="/docs/0.9.x/plugin-development/plugin-configuration" >Plugin configuration</a>
            </li>
            
            
            <li>
              <a href="/docs/0.9.x/plugin-development/access-the-datastore" class="active">Access the datastore</a>
            </li>
            
            
            <li>
              <a href="/docs/0.9.x/plugin-development/custom-entities" >Store custom entities</a>
            </li>
            
            
            <li>
              <a href="/docs/0.9.x/plugin-development/entities-cache" >Caching custom entities</a>
            </li>
            
            
            <li>
              <a href="/docs/0.9.x/plugin-development/admin-api" >Extending the Admin API</a>
            </li>
            
            
            <li>
              <a href="/docs/0.9.x/plugin-development/tests" >Writing tests</a>
            </li>
            
            
            <li>
              <a href="/docs/0.9.x/plugin-development/distribution" >Distribute your plugin</a>
            </li>
            
          </ul>
          
        </li>
        
      </ul>
    </nav>
    
    <nav>
      
      <a href="/docs/0.9.x/admin-api/"><h5>Admin API</h5></a>
      
      <ul>
        
        
        <li>
          <a href="/docs/0.9.x/admin-api/#supported-content-types" >Supported Content Types</a>
          
        </li>
        
        
        <li>
          <a href="/docs/0.9.x/admin-api/#information-routes" >Information routes</a>
          
          <ul>
            
            
            <li>
              <a href="/docs/0.9.x/admin-api/#retrieve-node-information" >Retrieve node information</a>
            </li>
            
            
            <li>
              <a href="/docs/0.9.x/admin-api/#retrieve-node-status" >Retrieve node status</a>
            </li>
            
          </ul>
          
        </li>
        
        
        <li>
          <a href="/docs/0.9.x/admin-api/#cluster" >Cluster</a>
          
          <ul>
            
            
            <li>
              <a href="/docs/0.9.x/admin-api/#retrieve-cluster-status" >Retrieve cluster status</a>
            </li>
            
            
            <li>
              <a href="/docs/0.9.x/admin-api/#forcibly-remove-a-node" >Forcibly remove a node</a>
            </li>
            
          </ul>
          
        </li>
        
        
        <li>
          <a href="/docs/0.9.x/admin-api/#api-object" >API Object routes</a>
          
          <ul>
            
            
            <li>
              <a href="/docs/0.9.x/admin-api/#add-api" >Add API</a>
            </li>
            
            
            <li>
              <a href="/docs/0.9.x/admin-api/#retrieve-api" >Retrieve API</a>
            </li>
            
            
            <li>
              <a href="/docs/0.9.x/admin-api/#list-apis" >List APIs</a>
            </li>
            
            
            <li>
              <a href="/docs/0.9.x/admin-api/#update-api" >Update API</a>
            </li>
            
            
            <li>
              <a href="/docs/0.9.x/admin-api/#update-or-create-api" >Update or create API</a>
            </li>
            
            
            <li>
              <a href="/docs/0.9.x/admin-api/#delete-api" >Delete API</a>
            </li>
            
          </ul>
          
        </li>
        
        
        <li>
          <a href="/docs/0.9.x/admin-api/#consumer-object" >Consumer Object routes</a>
          
          <ul>
            
            
            <li>
              <a href="/docs/0.9.x/admin-api/#create-consumer" >Create Consumer</a>
            </li>
            
            
            <li>
              <a href="/docs/0.9.x/admin-api/#retrieve-consumer" >Retrieve Consumer</a>
            </li>
            
            
            <li>
              <a href="/docs/0.9.x/admin-api/#list-consumers" >List Consumers</a>
            </li>
            
            
            <li>
              <a href="/docs/0.9.x/admin-api/#update-consumer" >Update Consumer</a>
            </li>
            
            
            <li>
              <a href="/docs/0.9.x/admin-api/#update-or-create-consumer" >Update or create Consumer</a>
            </li>
            
            
            <li>
              <a href="/docs/0.9.x/admin-api/#delete-consumer" >Delete Consumer</a>
            </li>
            
          </ul>
          
        </li>
        
        
        <li>
          <a href="/docs/0.9.x/admin-api/#plugin-object" >Plugin Object routes</a>
          
          <ul>
            
            
            <li>
              <a href="/docs/0.9.x/admin-api/#add-plugin" >Add Plugin</a>
            </li>
            
            
            <li>
              <a href="/docs/0.9.x/admin-api/#retrieve-plugin" >Retrieve Plugin</a>
            </li>
            
            
            <li>
              <a href="/docs/0.9.x/admin-api/#list-all-plugins" >List all Plugins</a>
            </li>
            
            
            <li>
              <a href="/docs/0.9.x/admin-api/#list-plugins-per-api" >List Plugins per API</a>
            </li>
            
            
            <li>
              <a href="/docs/0.9.x/admin-api/#update-plugin" >Update Plugin</a>
            </li>
            
            
            <li>
              <a href="/docs/0.9.x/admin-api/#update-or-add-plugin" >Update or Add Plugin</a>
            </li>
            
            
            <li>
              <a href="/docs/0.9.x/admin-api/#delete-plugin" >Delete Plugin</a>
            </li>
            
            
            <li>
              <a href="/docs/0.9.x/admin-api/#retrieve-enabled-plugins" >Retrieve Enabled Plugins</a>
            </li>
            
            
            <li>
              <a href="/docs/0.9.x/admin-api/#retrieve-plugin-schema" >Retrieve Plugin Schema</a>
            </li>
            
          </ul>
          
        </li>
        
      </ul>
    </nav>
    
  </aside>

  <div class="page-content-container">
    <div class="page-content">
      <div class="content">
        

      <h1 id="plugin-development-accessing-the-datastore">Plugin Development - Accessing the datastore</h1>

<p>Kong interacts with the model layer through classes we refer to as "DAOs". This chapter will detail the available API to interact with the datastore.</p>

<p>As of <code>0.8.0</code>, Kong supports two primary datastores: <a href="http://cassandra.apache.org/">Cassandra 2.2.x</a> and <a href="http://www.postgresql.org/">PostgreSQL 9.4+</a>.</p>

<hr>

<h3 id="the-dao-factory">The DAO Factory</h3>

<p>All entities in Kong are represented by:</p>

<ul>
<li>A schema that describes which table the entity relates to in the datastore, constraints on its fields such as foreign keys, non-null constraints etc... This schema is a table described in the <a href="/docs/0.9.x/plugin-development/plugin-configuration/">plugin configuration</a> chapter.</li>
<li>An instance of the <code>DAO</code> class mapping to the database currently in use (Cassandra or PostgreSQL). This class' methods consume the schema and expose methods to insert, update, find and delete entities of that type.</li>
</ul>

<p>The core entities in Kong are: Apis, Consumers and Plugins. Each of these entities can be interacted with through their corresponding DAO instance, available through the <strong>DAO Factory</strong> instance. The DAO Factory is responsible for loading these core entities' DAOs as well as any additional entities, provided for example by plugins.</p>

<p>The DAO Factory is a singleton instance in Kong and thus, is accessible through the <code>singletons</code> module:</p>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="kd">local</span> <span class="n">singletons</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">"</span><span class="s">kong.singletons"</span>

<span class="c1">-- Core DAOs</span>
<span class="kd">local</span> <span class="n">apis_dao</span> <span class="o">=</span> <span class="n">singletons</span><span class="p">.</span><span class="n">dao</span><span class="p">.</span><span class="n">apis</span>
<span class="kd">local</span> <span class="n">consumers_dao</span> <span class="o">=</span> <span class="n">singletons</span><span class="p">.</span><span class="n">dao</span><span class="p">.</span><span class="n">consumers</span>
<span class="kd">local</span> <span class="n">plugins_dao</span> <span class="o">=</span> <span class="n">singletons</span><span class="p">.</span><span class="n">dao</span><span class="p">.</span><span class="n">plugins</span>
</code></pre></div>
<hr>

<h3 id="the-dao-lua-api">The DAO Lua API</h3>

<p>The DAO class is responsible for the operations executed on a given table in the datastore, generally mapping to an entity in Kong. All the underlying supported databases (currently Cassandra and PostgreSQL) comply to the same interface, thus making the DAO compatible with all of them.</p>

<p>For example, inserting an API is as easy as:</p>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="kd">local</span> <span class="n">singletons</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">"</span><span class="s">kong.singletons"</span>
<span class="kd">local</span> <span class="n">dao</span> <span class="o">=</span> <span class="n">singletons</span><span class="p">.</span><span class="n">dao</span>

<span class="kd">local</span> <span class="n">inserted_api</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">dao</span><span class="p">.</span><span class="n">apis</span><span class="p">:</span><span class="n">insert</span><span class="p">({</span>
  <span class="n">name</span> <span class="o">=</span> <span class="s2">"</span><span class="s">mockbin"</span><span class="p">,</span>
  <span class="n">upstream_url</span> <span class="o">=</span> <span class="s2">"</span><span class="s">http://mockbin.com"</span><span class="p">,</span>
  <span class="n">request_host</span> <span class="o">=</span> <span class="s2">"</span><span class="s">mockbin.com"</span>
<span class="p">})</span>
</code></pre></div>
<hr>

<p>Next: <a href="/docs/0.9.x/plugin-development/custom-entities/">Custom Entities ›</a></p>

      </div>
    </div>
  </div>
</div>


    <footer class="footer">
  
    <section class="section subscribe-section" id="newsletter">
  <div class="container">
    <header class="section-header">
      <h4>跟踪最新特性</h4>
    </header>


    <form action="/" class="subscribe-form">
      <div class="spinner">
        <div class="bounce1"></div>
        <div class="bounce2"></div>
        <div class="bounce3"></div>
      </div>

      <div class="alert alert-success" role="alert">谢谢!</div>

      <div class="input-group">
        <input type="email" name="email" placeholder="youre@awesome.com" required/>
        <button class="button button-primary" type="submit">订阅</button>
      </div>
    </form>
  </div>
</section>

  

  <div class="footer-bar">
    <div class="container">
      <ul class="footer-social">
        <li><!-- verse link.web with link.share in the header -->
          
          <div class="fb-share-button" data-href="https://getkong.org" data-layout="button"></div>
        </li>
        <li>
          <a href="https://twitter.com/share" class="twitter-share-button" data-url="http://getkong.org" data-text="KONG - the open-source management layer for APIs and Microservices" data-hashtags="opensource,API,management">Tweet</a>
        </li>
        <li>
          <a class="github-button" href="https://github.com/Mashape/kong" data-icon="octicon-star" data-count-href="/mashape/kong/stargazers" data-count-api="/repos/mashape/kong#stargazers_count" data-count-aria-label="# stargazers on GitHub" aria-label="Star mashape/kong on GitHub">Star</a>
        </li>
      </ul>
    <span> <a href="https://mashape.com"> <img src="/assets/images/branding-footer.svg" alt="Mashape" width="22" height="26"/> © <strong>2016 Mashape Inc</strong> </a> </span> <span class="footer-separator"></span> <span class="footer-nav"> <a href="/license">许可证</a> <a href="/terms">条款</a> <a href="/privacy">隐私</a> <a href="https://www.mashape.com/enterprise/">企业版</a> <a href="http://blog.mashape.com/category/open-source/" target="_blank">新闻</a> </span>
    </div>
  </div>
</footer>


    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="/assets/app.js?v=1474440736"></script>

    <div id="fb-root"></div>

    <a id="support-bubble" href="https://gitter.im/Mashape/kong" class="js-gitter-toggle-chat-button" data-gitter-toggle-chat-state="true"></a>

    <script id="github-bjs" src="https://buttons.github.io/buttons.js" async defer></script>
    <script id="twitter-wjs" type="text/javascript" src="https://platform.twitter.com/widgets.js" async defer></script>
    <script id="facebook-jssdk" type="text/javascript" src="https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.3&appId=842731852424506" async defer></script>

    <script type='text/javascript'>
      var _vwo_code=(function(){
      var account_id=125292,
      settings_tolerance=2000,
      library_tolerance=2500,
      use_existing_jquery=true,
      // DO NOT EDIT BELOW THIS LINE
      f=false,d=document;return{use_existing_jquery:function(){return use_existing_jquery;},library_tolerance:function(){return library_tolerance;},finish:function(){if(!f){f=true;var a=d.getElementById('_vis_opt_path_hides');if(a)a.parentNode.removeChild(a);}},finished:function(){return f;},load:function(a){var b=d.createElement('script');b.src=a;b.type='text/javascript';b.innerText;b.onerror=function(){_vwo_code.finish();};d.getElementsByTagName('head')[0].appendChild(b);},init:function(){settings_timer=setTimeout('_vwo_code.finish()',settings_tolerance);this.load('//dev.visualwebsiteoptimizer.com/j.php?a='+account_id+'&u='+encodeURIComponent(d.URL)+'&r='+Math.random());var a=d.createElement('style'),b='body{opacity:0 !important;filter:alpha(opacity=0) !important;background:none !important;}',h=d.getElementsByTagName('head')[0];a.setAttribute('id','_vis_opt_path_hides');a.setAttribute('type','text/css');if(a.styleSheet)a.styleSheet.cssText=b;else a.appendChild(d.createTextNode(b));h.appendChild(a);return settings_timer;}};}());_vwo_settings_timer=_vwo_code.init();
    </script>

    <script type="text/javascript">
      !function(){var analytics=window.analytics=window.analytics||[];if(!analytics.initialize)if(analytics.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{analytics.invoked=!0;analytics.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","group","track","ready","alias","page","once","off","on"];analytics.factory=function(t){return function(){var e=Array.prototype.slice.call(arguments);e.unshift(t);analytics.push(e);return analytics}};for(var t=0;t<analytics.methods.length;t++){var e=analytics.methods[t];analytics[e]=analytics.factory(e)}analytics.load=function(t){var e=document.createElement("script");e.type="text/javascript";e.async=!0;e.src=("https:"===document.location.protocol?"https://":"http://")+"cdn.segment.com/analytics.js/v1/"+t+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(e,n)};analytics.SNIPPET_VERSION="3.0.1";
        analytics.load("WDj0nSS7hpyxwL3evgbOzK755s0NUye6");
        analytics.page()
      }}();
    </script>

    <script type="text/javascript" src="//mashape.github.io/notification-bar/embed.js" async defer></script>
    <script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>
  </body>
</html>
